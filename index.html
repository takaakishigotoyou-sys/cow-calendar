<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç‰›ã®ç¹æ®–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ”¹å–„ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f6f7f9;
      --primary:#2f855a;
      --card-bg:#fff;
      --muted:#555;
      --accent-red: #c53030;
      --accent-green: #2f855a;
    }
    *{box-sizing:border-box}
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      margin: 0;
      background: var(--bg);
      color:#222;
    }
    header {
      background: var(--primary);
      color: white;
      padding: 12px 16px;
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .container {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
    }
    /* Form / list */
    form {
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    form div { margin-bottom: 8px; }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
    }
    button:hover { opacity: 0.95; cursor: pointer; }

    .cow-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .cow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .small {
      font-size: 0.9rem;
      color: var(--muted);
    }

    /* å¼·èª¿ãƒ©ãƒ™ãƒ«ï¼ˆç«‹ä½“çš„ï¼‰ */
    .date-highlight, .date-highlight-green {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.95rem;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12), inset 0 -4px 8px rgba(0,0,0,0.06);
      transform: translateY(-2px);
      text-shadow: 0 1px 0 rgba(255,255,255,0.25);
      border: 1px solid rgba(0,0,0,0.06);
      white-space: nowrap;
    }

    .date-highlight {
      color: #6b1b1b;
      background: linear-gradient(180deg, #fff3cd 0%, #fee2d4 60%, #fef3c7 100%);
      box-shadow: 0 10px 22px rgba(197,57,57,0.12), 0 2px 6px rgba(0,0,0,0.06);
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
      border: 1px solid rgba(197,57,57,0.18);
    }
    .date-highlight-green {
      color: #07372a;
      background: linear-gradient(180deg, #d1fae5 0%, #bbf1d5 60%, #ecfdf5 100%);
      box-shadow: 0 10px 22px rgba(44,115,72,0.12), 0 2px 6px rgba(0,0,0,0.06);
      text-shadow: 0 1px 0 rgba(255,255,255,0.6);
      border: 1px solid rgba(34,138,82,0.15);
    }

    /* Calendar column */
    .right-column {
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .calendar-card {
      background: var(--card-bg);
      padding:12px;
      border-radius:8px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .cal-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .cal-grid {
      display:grid;
      grid-template-columns: repeat(7,1fr);
      gap:6px;
    }
    .weekday {
      text-align:center;
      font-weight:700;
      font-size:0.85rem;
      padding:6px 4px;
      color:#444;
    }
    .day-cell {
      min-height:84px;
      background:#fbfcfd;
      border-radius:8px;
      padding:8px;
      position:relative;
      box-shadow: 0 3px 8px rgba(0,0,0,0.04);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
      overflow:hidden;
    }
    .day-cell:hover{ transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
    .day-number {
      font-weight:700;
      font-size:0.95rem;
      margin-bottom:6px;
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒƒã‚¸ï¼ˆæ–‡å­—ä»˜ãç«‹ä½“ï¼‰ */
    .event-badges {
      position:absolute;
      right:8px;
      bottom:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge {
      min-width: 28px;
      height: 18px;
      padding: 0 6px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 700;
      color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(0,0,0,0.18),
                  inset 0 -3px 5px rgba(255,255,255,0.35);
      cursor: pointer;
      user-select: none;
    }

    .badge.preg-check {
      background: linear-gradient(180deg,#ffe5dc,#ffb3a3);
      color:#7a1f1f;
      border: 1px solid rgba(197,57,57,0.12);
    }

    .badge.due {
      background: linear-gradient(180deg,#d1fae5,#7fd18a);
      color:#065f46;
      border: 1px solid rgba(34,138,82,0.11);
    }

    /* Modal */
    .modal-overlay {
      position:fixed;
      inset:0;
      background: rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:16px;
    }
    .modal {
      background: var(--card-bg);
      border-radius:12px;
      padding:16px;
      width:100%;
      max-width:520px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.28);
      max-height:80vh;
      overflow:auto;
    }
    .modal h3 { margin-top:0; }
    .modal .event-item {
      padding:10px;
      border-radius:8px;
      margin-bottom:8px;
      background: linear-gradient(180deg,#fff,#fbfbfb);
      box-shadow: 0 6px 12px rgba(0,0,0,0.05);
      border:1px solid #f0f0f0;
    }
    .modal .meta { font-size:0.9rem; color:var(--muted); margin-top:6px; }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width:1000px){
      .container{ grid-template-columns: 1fr; }
      .right-column{ order: -1; }
    }

  </style>
</head>
<body>
  <header>ğŸ„ ç‰›ã®ç¹æ®–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ”¹å–„ç‰ˆï¼‰</header>
  <div class="container">
    <div>
      <form id="cowForm">
        <div>
          <label>æ¯ç‰›ã®åå‰</label>
          <input type="text" id="cowName" required />
        </div>
        <div>
          <label>äººå·¥æˆç²¾æ—¥</label>
          <input type="date" id="inseminationDate" required />
        </div>
        <div>
          <label>æˆç²¾ç¨®é›„ç‰›ã®åå‰</label>
          <input type="text" id="bullName" />
        </div>
        <button type="submit">ç™»éŒ²</button>
      </form>

      <div id="cowList"></div>
    </div>

    <div class="right-column">
      <div class="calendar-card">
        <div class="cal-header">
          <div>
            <button id="prevMonth" title="å‰ã®æœˆ">&lt;</button>
            <button id="nextMonth" title="æ¬¡ã®æœˆ">&gt;</button>
          </div>
          <div id="calTitle" style="font-weight:700"></div>
          <div>
            <button id="todayBtn">ä»Šæ—¥</button>
          </div>
        </div>
        <div class="cal-grid" id="weekdayHeader">
          <div class="weekday">æ—¥</div>
          <div class="weekday">æœˆ</div>
          <div class="weekday">ç«</div>
          <div class="weekday">æ°´</div>
          <div class="weekday">æœ¨</div>
          <div class="weekday">é‡‘</div>
          <div class="weekday">åœŸ</div>
        </div>
        <div class="cal-grid" id="calendarGrid"></div>
      </div>

      <div class="calendar-card small">
        <strong>å‡¡ä¾‹</strong>
        <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
          <div style="display:flex;gap:8px;align-items:center"><span class="badge preg-check" style="width:18px;height:18px;padding:0;border-radius:50%;"></span><span>å¦Šå¨ é‘‘å®šäºˆå®š</span></div>
          <div style="display:flex;gap:8px;align-items:center"><span class="badge due" style="width:18px;height:18px;padding:0;border-radius:50%;"></span><span>åˆ†å¨©äºˆå®š</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
      <button id="closeModal" style="float:right">é–‰ã˜ã‚‹</button>
      <h3 id="modalDateTitle"></h3>
      <div id="modalEvents"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "cowCalendarData_v2";

    /* --- Utilities: å®‰å…¨ãªæ—¥ä»˜å‡¦ç† --- */
    function parseYMD(ymd){
      const [y,m,d] = String(ymd).split("-");
      return new Date(Number(y), Number(m)-1, Number(d));
    }
    function formatYMD(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,"0");
      const d = String(date.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function addDaysYMD(ymd, days){
      const dt = parseYMD(ymd);
      dt.setDate(dt.getDate() + days);
      return formatYMD(dt);
    }

    /* --- storage --- */
    function loadCows(){
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
      } catch (e) {
        console.error("storage parse error", e);
        return [];
      }
    }
    function saveCows(cows){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cows));
    }

    /* --- ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆï¼ˆç‰›ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰ --- 
       ãƒ­ã‚¸ãƒƒã‚¯:
         - status === 'open' ã®å ´åˆã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸€åˆ‡ç”Ÿæˆã—ãªã„ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤ºã—ãªã„ï¼‰
         - status === 'pregnant' ã®å ´åˆã¯ã€Œåˆ†å¨©äºˆå®šã€ã®ã¿ç”Ÿæˆï¼ˆå¦Šå¨ é‘‘å®šã¯æ—¢ã«æ¸ˆã‚“ã§ã„ã‚‹æƒ³å®šï¼‰
         - status === 'inseminated' ã¯å¦Šå¨ é‘‘å®š + åˆ†å¨©äºˆå®šã‚’ç”Ÿæˆ
         - ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¸¡æ–¹ç”Ÿæˆï¼ˆäº’æ›æ€§ï¼‰
    */
    function eventsFromCows(){
      const cows = loadCows();
      const events = [];
      cows.forEach((cow, idx) => {
        if (!cow || !cow.inseminationDate) return;
        const status = cow.status || "inseminated";
        const pregCheck = addDaysYMD(cow.inseminationDate, 60);
        const due = addDaysYMD(cow.inseminationDate, 285);

        if (status === "open") {
          // ç©ºèƒã¯ã™ã¹ã¦éè¡¨ç¤º -> ä½•ã‚‚ã—ãªã„
          return;
        }

        if (status === "pregnant") {
          // å¦Šå¨ ä¸­: åˆ†å¨©äºˆå®šã®ã¿
          events.push({
            date: due,
            kind: "due",
            title: "åˆ†å¨©äºˆå®š",
            cowIndex: idx,
            cowName: cow.name,
            bull: cow.bull,
            inseminationDate: cow.inseminationDate,
            status: cow.status
          });
          return;
        }

        // inseminated ã¾ãŸã¯ãã®ä»–: ä¸¡æ–¹è¡¨ç¤ºï¼ˆé‘‘å®š + åˆ†å¨©ï¼‰
        events.push({
          date: pregCheck,
          kind: "preg-check",
          title: "å¦Šå¨ é‘‘å®šäºˆå®š",
          cowIndex: idx,
          cowName: cow.name,
          bull: cow.bull,
          inseminationDate: cow.inseminationDate,
          status: cow.status
        });
        events.push({
          date: due,
          kind: "due",
          title: "åˆ†å¨©äºˆå®š",
          cowIndex: idx,
          cowName: cow.name,
          bull: cow.bull,
          inseminationDate: cow.inseminationDate,
          status: cow.status
        });
      });
      return events;
    }

    /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ --- */
    let viewYear, viewMonth; // month: 0-11
    function initCalendar(){
      const today = new Date();
      viewYear = today.getFullYear();
      viewMonth = today.getMonth();
      document.getElementById("prevMonth").addEventListener("click", ()=>{ changeMonth(-1); });
      document.getElementById("nextMonth").addEventListener("click", ()=>{ changeMonth(1); });
      document.getElementById("todayBtn").addEventListener("click", ()=>{ viewYear = new Date().getFullYear(); viewMonth = new Date().getMonth(); renderCalendar(); });
      renderCalendar();
    }

    function changeMonth(delta){
      viewMonth += delta;
      if (viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
      if (viewMonth > 11){ viewMonth = 0; viewYear += 1; }
      renderCalendar();
    }

    function renderCalendar(){
      const calTitle = document.getElementById("calTitle");
      const grid = document.getElementById("calendarGrid");
      grid.innerHTML = "";
      const monthStart = new Date(viewYear, viewMonth, 1);
      const monthEnd = new Date(viewYear, viewMonth+1, 0);
      calTitle.textContent = `${viewYear}å¹´ ${viewMonth+1}æœˆ`;

      // first day index (0=æ—¥)
      const startIdx = monthStart.getDay();
      const daysInMonth = monthEnd.getDate();

      const events = eventsFromCows();
      // map date -> array
      const map = {};
      events.forEach(ev => {
        if (!map[ev.date]) map[ev.date] = [];
        map[ev.date].push(ev);
      });

      // fill blanks before start
      for (let i=0;i<startIdx;i++){
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.opacity = "0.4";
        blank.style.pointerEvents = "none";
        grid.appendChild(blank);
      }

      for (let day=1; day<=daysInMonth; day++){
        const ymd = formatYMD(new Date(viewYear, viewMonth, day));
        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.dataset.ymd = ymd;

        const num = document.createElement("div");
        num.className = "day-number";
        num.textContent = day;
        cell.appendChild(num);

        // badges
        const badgeContainer = document.createElement("div");
        badgeContainer.className = "event-badges";
        const evs = map[ymd] || [];
        // show up to 3 badges
        evs.slice(0,3).forEach(ev => {
          const b = document.createElement("span");
          b.className = "badge " + ev.kind;
          b.textContent = ev.kind === "preg-check" ? "é‘‘å®š" : "åˆ†å¨©";

          b.addEventListener("click", (e) => {
            e.stopPropagation(); // æ—¥ä»˜ã‚»ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚’é˜²ã
            openEventModal(ev);
          });

          badgeContainer.appendChild(b);
        });
        if (evs.length>0) cell.appendChild(badgeContainer);

        // click -> æ—¥ä»˜ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆä¸€è¦§ï¼‰
        cell.addEventListener("click", ()=> {
          openModalForDate(ymd, evs);
        });

        grid.appendChild(cell);
      }

      // fill trailing blanks to keep grid consistent (optional)
      const totalCells = startIdx + daysInMonth;
      const trailing = (7 - (totalCells % 7)) % 7;
      for (let i=0;i<trailing;i++){
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.opacity = "0.4";
        blank.style.pointerEvents = "none";
        grid.appendChild(blank);
      }
    }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    const modalOverlay = document.getElementById("modalOverlay");
    const modalEvents = document.getElementById("modalEvents");
    const modalDateTitle = document.getElementById("modalDateTitle");
    document.getElementById("closeModal").addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e)=>{ if(e.target===modalOverlay) closeModal(); });

    function openModalForDate(ymd, evs){
      modalDateTitle.textContent = `${ymd} ã®ã‚¤ãƒ™ãƒ³ãƒˆ`;
      modalEvents.innerHTML = "";
      if (!evs || evs.length===0){
        modalEvents.innerHTML = `<div class="small">ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      } else {
        evs.forEach(ev => {
          const item = document.createElement("div");
          item.className = "event-item";

          const topRow = document.createElement("div");
          topRow.style.display = "flex";
          topRow.style.justifyContent = "space-between";
          topRow.style.alignItems = "center";

          const left = document.createElement("div");
          const strong = document.createElement("strong");
          strong.textContent = ev.title;
          left.appendChild(strong);

          const badge = document.createElement("span");
          badge.style.display = "inline-block";
          badge.style.verticalAlign = "middle";
          badge.style.marginLeft = "8px";
          badge.style.width = "12px";
          badge.style.height = "12px";
          badge.style.borderRadius = "50%";
          badge.style.boxShadow = "0 6px 12px rgba(0,0,0,0.12)";
          badge.style.background = ev.kind === "preg-check" ? "#ffb3a3" : "#7fd18a";
          left.appendChild(badge);

          const right = document.createElement("div");
          right.className = "small";
          right.textContent = `ç‰›: ${ev.cowName}`;

          topRow.appendChild(left);
          topRow.appendChild(right);

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `äººå·¥æˆç²¾æ—¥: ${ev.inseminationDate} ãƒ» é›„ç‰›: ${ev.bull || 'â€”'} ãƒ» ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${ev.status}`;

          const actions = document.createElement("div");
          actions.style.marginTop = "8px";
          const detailsBtn = document.createElement("button");
          detailsBtn.textContent = "è©³ç´°ï¼æ“ä½œ";
          detailsBtn.addEventListener("click", ()=> {
            openEventModalFromIndex(ev.cowIndex, ev.date, ev.kind);
          });

          actions.appendChild(detailsBtn);

          item.appendChild(topRow);
          item.appendChild(meta);
          item.appendChild(actions);

          modalEvents.appendChild(item);
        });
      }
      modalOverlay.style.display = "flex";
    }

    function closeModal(){
      modalOverlay.style.display = "none";
    }

    /* --- ã‚¤ãƒ™ãƒ³ãƒˆå°‚ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå˜ä¸€ã‚¤ãƒ™ãƒ³ãƒˆã®è©³ç´°ï¼†æ“ä½œï¼‰ --- */
    function openEventModal(ev){
      // ev: object
      const selHTML = `
        <select id="eventStatusSelect">
          <option value="inseminated" ${ev.status === 'inseminated' ? 'selected' : ''}>æˆç²¾æ¸ˆã¿</option>
          <option value="pregnant" ${ev.status === 'pregnant' ? 'selected' : ''}>å¦Šå¨ ä¸­</option>
          <option value="open" ${ev.status === 'open' ? 'selected' : ''}>ç©ºèƒ</option>
        </select>
      `;

      modalDateTitle.textContent = `${ev.date} â€” ${ev.title}`;
      modalEvents.innerHTML = `
        <div class="event-item">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${ev.title}</strong></div>
            <div class="small">ç‰›: ${ev.cowName}</div>
          </div>
          <div class="meta">äººå·¥æˆç²¾æ—¥: ${ev.inseminationDate} ãƒ» é›„ç‰›: ${ev.bull || 'â€”'}</div>
          <div style="margin-top:10px">
            <label><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´</strong></label>
            ${selHTML}
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="saveStatusBtn">ä¿å­˜</button>
              <button id="gotoCowBtn">ã“ã®ç‰›ã®è©³ç´°ã‚’è¦‹ã‚‹</button>
            </div>
          </div>
        </div>
      `;

      // save handler
      setTimeout(()=>{
        const saveBtn = document.getElementById('saveStatusBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', ()=>{
            const sel = document.getElementById('eventStatusSelect');
            const newStatus = sel ? sel.value : ev.status;
            updateCowStatus(ev.cowIndex, newStatus);
            closeModal();
          });
        }
        const gotoBtn = document.getElementById('gotoCowBtn');
        if (gotoBtn) {
          gotoBtn.addEventListener('click', ()=>{
            scrollToCow(ev.cowIndex);
          });
        }
      }, 10);

      modalOverlay.style.display = 'flex';
    }

    // helper used when opening from date-list -> pass cowIndex, date, kind
    function openEventModalFromIndex(cowIndex, date, kind){
      const cows = loadCows();
      const cow = cows[cowIndex];
      if(!cow) return alert('æŒ‡å®šã®ç‰›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      const ev = {
        date,
        kind,
        title: kind === 'preg-check' ? 'å¦Šå¨ é‘‘å®šäºˆå®š' : 'åˆ†å¨©äºˆå®š',
        cowIndex,
        cowName: cow.name,
        bull: cow.bull,
        inseminationDate: cow.inseminationDate,
        status: cow.status
      };
      openEventModal(ev);
    }

    function updateCowStatus(index, status){
      const cows = loadCows();
      if(!cows[index]) return;
      cows[index].status = status;
      saveCows(cows);
      renderCowList();
      renderCalendar();
    }

    /* --- ç‰›ãƒªã‚¹ãƒˆæç”» --- 
       è¦ç‚¹:
         - status === 'open' ã®å ´åˆã¯ã€Œæ¬¡å›ç™ºæƒ…/é‘‘å®š/åˆ†å¨©ã€ç­‰ã®äºˆå®šè¡¨ç¤ºã‚’éš ã™
         - status ã«å¿œã˜ã¦å¼·èª¿ãƒ©ãƒ™ãƒ«ã‚‚åˆ‡ã‚Šæ›¿ãˆã‚‹
    */
    function renderCowList(){
      const list = document.getElementById("cowList");
      list.innerHTML = "";
      const cows = loadCows();
      cows.forEach((cow, index) => {
        const card = document.createElement("div");
        card.className = "cow-card";

        const nextHeat = cow.inseminationDate ? addDaysYMD(cow.inseminationDate, 21) : 'â€”';
        const pregnancyCheck = cow.inseminationDate ? addDaysYMD(cow.inseminationDate, 60) : 'â€”';
        const dueDate = cow.inseminationDate ? addDaysYMD(cow.inseminationDate, 285) : 'â€”';

        // highlight (è¡¨ç¤ºãƒãƒªã‚·ãƒ¼ã«åˆã‚ã›ã¦)
        let highlightHTML = "";
        if (cow.status === "inseminated") {
          highlightHTML = `<span class="date-highlight">å¦Šå¨ é‘‘å®šäºˆå®šæ—¥: ${pregnancyCheck}</span>`;
        } else if (cow.status === "pregnant") {
          highlightHTML = `<span class="date-highlight-green">åˆ†å¨©äºˆå®šæ—¥: ${dueDate}</span>`;
        } else if (cow.status === "open") {
          highlightHTML = `<span class="date-highlight" style="opacity:0.6">äºˆå®šã¯éè¡¨ç¤º</span>`;
        } else {
          highlightHTML = `<span class="date-highlight">å¦Šå¨ é‘‘å®šäºˆå®šæ—¥: ${pregnancyCheck}</span><span style="margin-left:8px" class="date-highlight-green">åˆ†å¨©äºˆå®šæ—¥: ${dueDate}</span>`;
        }

        // details: insemination ã¯å¸¸ã«è¡¨ç¤ºã€‚ãã®ä»–ã®äºˆå®šã¯ status ãŒ 'open' ã®å ´åˆã¯éè¡¨ç¤ºã€‚
        let detailsHTML = `<div class="small">äººå·¥æˆç²¾æ—¥: ${cow.inseminationDate || 'â€”'}</div>`;
        if (cow.status !== "open") {
          detailsHTML += `<div class="small">æ¬¡å›ç™ºæƒ…äºˆå®šæ—¥: ${nextHeat}</div>`;
          detailsHTML += `<div class="small">ç©ºèƒæ¤œæŸ»äºˆå®šæ—¥: ${pregnancyCheck}</div>`;
          detailsHTML += `<div class="small">åˆ†å¨©äºˆå®šæ—¥: ${dueDate}</div>`;
        } else {
          detailsHTML += `<div class="small" style="opacity:0.7">ï¼ˆç©ºèƒ: äºˆå®šã¯éè¡¨ç¤ºï¼‰</div>`;
        }

        card.innerHTML = `
          <div class="cow-header">
            <div><strong>${cow.name}</strong> <span class="small">(${cow.bull || 'â€”'})</span></div>
            <select data-index="${index}" class="status-select">
              <option value="inseminated" ${cow.status === "inseminated" ? "selected" : ""}>æˆç²¾æ¸ˆã¿</option>
              <option value="pregnant" ${cow.status === "pregnant" ? "selected" : ""}>å¦Šå¨ ä¸­</option>
              <option value="open" ${cow.status === "open" ? "selected" : ""}>ç©ºèƒ</option>
            </select>
          </div>
          ${detailsHTML}
          <div style="margin-top:8px">${highlightHTML}</div>
        `;
        list.appendChild(card);

        // attach change listener to select (ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãå€‹åˆ¥ç™»éŒ²)
        const sel = card.querySelector('.status-select');
        if (sel) {
          sel.addEventListener('change', (e) => {
            const newStatus = e.target.value;
            changeStatus(index, newStatus);
          });
        }
      });
    }

    function changeStatus(index, status){
      const cows = loadCows();
      if (!cows[index]) return;
      cows[index].status = status;
      saveCows(cows);
      renderCowList();
      renderCalendar();
    }

    /* --- ãƒ•ã‚©ãƒ¼ãƒ ç™»éŒ² --- */
    document.getElementById("cowForm").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("cowName").value.trim();
      const inseminationDate = document.getElementById("inseminationDate").value;
      const bull = document.getElementById("bullName").value.trim();
      if (!name || !inseminationDate) return alert("åå‰ã¨äººå·¥æˆç²¾æ—¥ã¯å¿…é ˆã§ã™ã€‚");
      const cow = {
        name,
        inseminationDate,
        bull,
        status: "inseminated"
      };
      const cows = loadCows();
      cows.push(cow);
      saveCows(cows);
      e.target.reset();
      renderCowList();
      renderCalendar();
    });

    /* --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼†å¼·èª¿ --- */
    function scrollToCow(index){
      const cards = document.querySelectorAll(".cow-card");
      const card = cards[index];
      if(!card) return;
      closeModal();
      card.scrollIntoView({behavior:"smooth",block:"center"});
      const prev = card.style.boxShadow;
      card.style.boxShadow = "0 0 0 4px #68d391";
      setTimeout(()=>card.style.boxShadow = prev || "0 6px 18px rgba(0,0,0,0.06)" , 1500);
    }

    /* --- åˆæœŸåŒ– --- */
    initCalendar();
    renderCowList();

  </script>
</body>
</html>
