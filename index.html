<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç‰›ã®ç¹æ®–ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ Pro</title>
  <style>
    :root{
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --primary: #2f855a;
      --primary-dark: #276749;
      --card-bg: rgba(255, 255, 255, 0.95);
      --muted: #555;
      --accent-red: #c53030;
      --accent-green: #2f855a;
      --shadow: 0 10px 40px rgba(0,0,0,0.1);
      --shadow-hover: 0 15px 50px rgba(0,0,0,0.15);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: #222;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Header with animation */
    header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      color: white;
      padding: 20px 16px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      animation: slideDown 0.5s ease;
    }
    
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes scaleIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .container {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 480px;
      gap: 24px;
    }
    
    /* Statistics Panel */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
      animation: fadeIn 0.6s ease 0.2s both;
    }
    
    .stat-card {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 4px;
    }
    
    /* Form improvements */
    form {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      animation: fadeIn 0.6s ease 0.3s both;
      position: relative;
      overflow: hidden;
    }
    
    form::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), #48bb78);
    }
    
    .form-title {
      font-size: 1.2rem;
      margin-bottom: 16px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
      color: #333;
    }
    
    input, select {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      background: white;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(47, 133, 90, 0.1);
    }
    
    button {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    button:hover::before {
      width: 300px;
      height: 300px;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(47, 133, 90, 0.3);
    }
    
    /* Search and Filter */
    .controls {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      align-items: center;
      animation: fadeIn 0.6s ease 0.4s both;
    }
    
    .search-input {
      flex: 1;
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    
    .filter-select {
      padding: 10px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    .btn-icon {
      width: auto;
      padding: 10px 16px;
      font-size: 0.9rem;
      background: #4299e1;
    }
    
    .btn-icon:hover {
      background: #3182ce;
    }
    
    /* Cow cards enhanced */
    .cow-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      border-left: 5px solid #ccc;
      transition: all 0.3s ease;
      animation: fadeIn 0.6s ease both;
    }
    
    .cow-card:hover {
      transform: translateX(5px);
      box-shadow: var(--shadow-hover);
    }
    
    .cow-card.status-inseminated { border-left-color: #f6ad55; }
    .cow-card.status-pregnant { border-left-color: #48bb78; }
    .cow-card.status-open { border-left-color: #fc8181; }
    
    .cow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .cow-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #2d3748;
    }
    
    .bull-name {
      font-size: 0.85rem;
      color: var(--muted);
      margin-left: 8px;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .date-highlight, .date-highlight-green {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 0.85rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-right: 8px;
      margin-top: 8px;
      transition: transform 0.2s;
    }
    
    .date-highlight:hover, .date-highlight-green:hover {
      transform: scale(1.05);
    }
    
    .date-highlight {
      color: #744210;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 1px solid #fbbf24;
    }
    
    .date-highlight-green {
      color: #065f46;
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 1px solid #6ee7b7;
    }
    
    /* Calendar enhancements */
    .right-column {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .calendar-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.6s ease 0.5s both;
    }
    
    .cal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .cal-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .cal-nav {
      display: flex;
      gap: 8px;
    }
    
    .cal-nav button {
      width: 40px;
      padding: 8px;
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    #todayBtn {
      width: auto;
      padding: 8px 16px;
      font-size: 0.85rem;
    }
    
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .weekday {
      text-align: center;
      font-weight: 700;
      font-size: 0.85rem;
      padding: 10px 4px;
      color: #4a5568;
      background: #f7fafc;
      border-radius: 6px;
    }
    
    .weekday:first-child { color: #e53e3e; }
    .weekday:last-child { color: #3182ce; }
    
    .day-cell {
      min-height: 90px;
      background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
      border-radius: 10px;
      padding: 10px;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .day-cell:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      border-color: var(--primary);
      background: white;
    }
    
    .day-number {
      font-weight: 700;
      font-size: 1rem;
      color: #2d3748;
    }
    
    .day-cell.today {
      background: linear-gradient(135deg, #bee3f8 0%, #90cdf4 100%);
      border-color: #3182ce;
    }
    
    .day-cell.today .day-number {
      color: #1a365d;
    }
    
    .event-badges {
      position: absolute;
      right: 6px;
      bottom: 6px;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    
    .badge {
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 0.65rem;
      font-weight: 700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      animation: scaleIn 0.3s ease;
    }
    
    .badge.preg-check {
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      color: #7a1f1f;
    }
    
    .badge.due {
      background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
      color: #22543d;
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: -100px;
      right: 30px;
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      transition: bottom 0.4s ease;
      min-width: 300px;
    }
    
    .toast.show {
      bottom: 30px;
    }
    
    .toast.success {
      border-left: 4px solid #48bb78;
    }
    
    .toast.error {
      border-left: 4px solid #f56565;
    }
    
    .toast-icon {
      font-size: 1.5rem;
    }
    
    .toast-message {
      flex: 1;
      font-weight: 600;
    }
    
    /* Custom Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 16px;
      animation: fadeIn 0.3s ease;
    }
    
    .modal {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.4);
      animation: scaleIn 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      font-size: 1.4rem;
      margin-bottom: 16px;
      color: var(--primary);
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .event-item {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 1px solid #e2e8f0;
      transition: transform 0.2s;
    }
    
    .event-item:hover {
      transform: translateX(5px);
      border-color: var(--primary);
    }
    
    /* Confirm Dialog */
    .confirm-dialog {
      background: white;
      border-radius: 16px;
      padding: 28px;
      max-width: 400px;
      text-align: center;
      animation: scaleIn 0.3s ease;
    }
    
    .confirm-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }
    
    .confirm-message {
      font-size: 1.1rem;
      margin-bottom: 24px;
      color: #2d3748;
    }
    
    .confirm-buttons {
      display: flex;
      gap: 12px;
    }
    
    .btn-cancel {
      background: #a0aec0;
    }
    
    .btn-cancel:hover {
      background: #718096;
    }
    
    .btn-danger {
      background: #f56565;
    }
    
    .btn-danger:hover {
      background: #e53e3e;
    }
    
    /* Export buttons */
    .export-controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .btn-small {
      width: auto;
      padding: 8px 12px;
      font-size: 0.8rem;
    }
    
    .btn-export {
      background: #4299e1;
    }
    
    .btn-export:hover {
      background: #3182ce;
    }
    
    .btn-import {
      background: #9f7aea;
    }
    
    .btn-import:hover {
      background: #805ad5;
    }
    
    /* Help tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #2d3748;
      color: white;
      text-align: center;
      border-radius: 8px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.8rem;
    }
    
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* Loading state */
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3000;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }
      .right-column {
        order: -1;
      }
      .stats-panel {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .controls {
        flex-direction: column;
      }
      .stats-panel {
        grid-template-columns: 1fr;
      }
    }
    
    /* Utility classes */
    .small { font-size: 0.9rem; color: var(--muted); }
    .hidden { display: none; }
    .text-center { text-align: center; }
    .mb-2 { margin-bottom: 8px; }
    .mt-2 { margin-top: 8px; }
  </style>
</head>
<body>

  <header>
    ğŸƒç‰›ã®ç¹æ®–ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ğŸƒ
    <div style="font-size:0.5em; margin-top:8px; opacity:0.9">
      äººå·¥æˆç²¾ã‹ã‚‰åˆ†å¨©ã¾ã§ä¸€å…ƒç®¡ç†
    </div>
  </header>

  <div class="container">
    <!-- Left Column -->
    <div>
      <!-- Statistics Panel -->
      <div class="stats-panel">
        <div class="stat-card">
          <div class="stat-number" id="statTotal">0</div>
          <div class="stat-label">ç·é ­æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statInseminated" style="color:#f6ad55">0</div>
          <div class="stat-label">æˆç²¾æ¸ˆã¿</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statPregnant" style="color:#48bb78">0</div>
          <div class="stat-label">å¦Šå¨ ä¸­</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="statOpen" style="color:#fc8181">0</div>
          <div class="stat-label">ç©ºèƒ</div>
        </div>
      </div>

      <!-- Form -->
      <form id="cowForm">
        <div class="form-title">
          â• æ–°è¦ç™»éŒ²
          <span class="tooltip">
            â“
            <span class="tooltiptext">äººå·¥æˆç²¾ã‚’è¡Œã£ãŸç‰›ã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™</span>
          </span>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>æ¯ç‰›ã®åå‰ *</label>
            <input type="text" id="cowName" placeholder="ä¾‹ï¼šã¯ãªã“" required />
          </div>
          <div class="form-group">
            <label>æˆç²¾ç¨®é›„ç‰›</label>
            <input type="text" id="bullName" placeholder="ä¾‹ï¼šå®‰ç¦ä¹…" />
          </div>
        </div>
        <div class="form-group">
          <label>äººå·¥æˆç²¾æ—¥ *</label>
          <input type="date" id="inseminationDate" required />
        </div>
        <button type="submit">âœ“ ç™»éŒ²ã™ã‚‹</button>
        
        <div class="export-controls">
          <button type="button" class="btn-small btn-export" onclick="exportData()">
            ğŸ“¤ ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›
          </button>
          <button type="button" class="btn-small btn-import" onclick="document.getElementById('importFile').click()">
            ğŸ“¥ ãƒ‡ãƒ¼ã‚¿èª­è¾¼
          </button>
          <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
        </div>
      </form>

      <!-- Search and Filter Controls -->
      <div class="controls">
        <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” ç‰›ã®åå‰ã§æ¤œç´¢...">
        <select class="filter-select" id="filterStatus" onchange="filterCows()">
          <option value="all">å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
          <option value="inseminated">æˆç²¾æ¸ˆã¿</option>
          <option value="pregnant">å¦Šå¨ ä¸­</option>
          <option value="open">ç©ºèƒ</option>
        </select>
        <select class="filter-select" id="sortBy" onchange="sortCows()">
          <option value="date">æ—¥ä»˜é †</option>
          <option value="name">åå‰é †</option>
        </select>
      </div>

      <!-- Cow List -->
      <div id="cowList"></div>
    </div>

    <!-- Right Column - Calendar -->
    <div class="right-column">
      <div class="calendar-card">
        <div class="cal-header">
          <div class="cal-nav">
            <button id="prevMonth">â—€</button>
            <button id="nextMonth">â–¶</button>
          </div>
          <div class="cal-title" id="calTitle"></div>
          <button id="todayBtn">ğŸ“… ä»Šæ—¥</button>
        </div>
        <div class="cal-grid">
          <div class="weekday">æ—¥</div>
          <div class="weekday">æœˆ</div>
          <div class="weekday">ç«</div>
          <div class="weekday">æ°´</div>
          <div class="weekday">æœ¨</div>
          <div class="weekday">é‡‘</div>
          <div class="weekday">åœŸ</div>
        </div>
        <div class="cal-grid" id="calendarGrid"></div>
      </div>

      <!-- Legend -->
      <div class="calendar-card small">
        <strong style="font-size:1rem">ğŸ“‹ å‡¡ä¾‹</strong>
        <div style="display:flex;gap:16px;margin-top:12px;flex-wrap:wrap">
          <span><span class="badge preg-check">é‘‘å®š</span> å¦Šå¨ é‘‘å®šäºˆå®š</span>
          <span><span class="badge due">åˆ†å¨©</span> åˆ†å¨©äºˆå®šæ—¥</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal-overlay" id="modalOverlay" onclick="if(event.target === this) closeModal()">
    <div class="modal">
      <h3 class="modal-title" id="modalDateTitle"></h3>
      <div id="modalEvents"></div>
      <button id="closeModal" style="background:#718096; margin-top:16px">âœ• é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- Confirm Dialog -->
  <div class="modal-overlay" id="confirmOverlay">
    <div class="confirm-dialog">
      <div class="confirm-icon">âš ï¸</div>
      <div class="confirm-message" id="confirmMessage"></div>
      <div class="confirm-buttons">
        <button class="btn-cancel" onclick="closeConfirm(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-danger" onclick="closeConfirm(true)">å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <div class="toast-icon" id="toastIcon"></div>
    <div class="toast-message" id="toastMessage"></div>
  </div>

  <!-- Loading Spinner -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    const STORAGE_KEY = "cow_breeding_data_v4";
    let confirmCallback = null;

    // æ—¥ä»˜è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    const dateUtil = {
      parse: (str) => new Date(str.replace(/-/g, '/')),
      format: (dt) => {
        const y = dt.getFullYear();
        const m = String(dt.getMonth()+1).padStart(2,'0');
        const d = String(dt.getDate()).padStart(2,'0');
        return `${y}-${m}-${d}`;
      },
      addDays: (str, days) => {
        const d = dateUtil.parse(str);
        d.setDate(d.getDate() + days);
        return dateUtil.format(d);
      },
      isToday: (dateStr) => {
        return dateStr === dateUtil.format(new Date());
      }
    };

    // ãƒ‡ãƒ¼ã‚¿æ“ä½œ
    function getCows() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    function saveCows(cows) { localStorage.setItem(STORAGE_KEY, JSON.stringify(cows)); }

    // Toasté€šçŸ¥
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const msg = document.getElementById('toastMessage');
      
      toast.className = `toast ${type}`;
      icon.textContent = type === 'success' ? 'âœ“' : 'âœ•';
      msg.textContent = message;
      
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showConfirm(message) {
      return new Promise((resolve) => {
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmOverlay').style.display = 'flex';
        confirmCallback = resolve;
      });
    }

    function closeConfirm(result) {
      document.getElementById('confirmOverlay').style.display = 'none';
      if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
      }
    }

    // çµ±è¨ˆæƒ…å ±æ›´æ–°
    function updateStats() {
      const cows = getCows();
      document.getElementById('statTotal').textContent = cows.length;
      document.getElementById('statInseminated').textContent = 
        cows.filter(c => c.status === 'inseminated').length;
      document.getElementById('statPregnant').textContent = 
        cows.filter(c => c.status === 'pregnant').length;
      document.getElementById('statOpen').textContent = 
        cows.filter(c => c.status === 'open').length;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
function getEvents() {
  const cows = getCows();
  const events = [];

  cows.forEach((cow, idx) => {
    if (cow.status === 'open') return;

    // ğŸŸ  æˆç²¾æ¸ˆã¿ â†’ å¦Šå¨ é‘‘å®šäºˆå®šï¼ˆ60æ—¥å¾Œï¼‰
    if (cow.status === 'inseminated') {
      events.push({
        date: dateUtil.addDays(cow.inseminationDate, 60),
        kind: 'preg-check',
        title: 'å¦Šå¨ é‘‘å®šäºˆå®š',
        cowName: cow.name,
        cowIndex: idx
      });
    }

    // ğŸŸ¢ å¦Šå¨ ä¸­ã®ã¿ â†’ åˆ†å¨©äºˆå®šï¼ˆ285æ—¥å¾Œï¼‰
    if (cow.status === 'pregnant') {
      events.push({
        date: dateUtil.addDays(cow.inseminationDate, 285),
        kind: 'due',
        title: 'åˆ†å¨©äºˆå®š',
        cowName: cow.name,
        cowIndex: idx
      });
    }
  });

  return events;
}


    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆ¶å¾¡
    let currentViewDate = new Date();

    function renderCalendar() {
      const grid = document.getElementById("calendarGrid");
      const title = document.getElementById("calTitle");
      grid.innerHTML = "";

      const y = currentViewDate.getFullYear();
      const m = currentViewDate.getMonth();
      title.textContent = `${y}å¹´ ${m + 1}æœˆ`;

      const firstDay = new Date(y, m, 1).getDay();
      const lastDate = new Date(y, m + 1, 0).getDate();
      const events = getEvents();
      const today = dateUtil.format(new Date());

      // ç©ºç™½ã‚»ãƒ«
      for (let i = 0; i < firstDay; i++) {
        const blank = document.createElement("div");
        blank.className = "day-cell";
        blank.style.opacity = "0";
        blank.style.cursor = "default";
        grid.appendChild(blank);
      }

      // æ—¥ä»˜ã‚»ãƒ«
      for (let d = 1; d <= lastDate; d++) {
        const dateStr = dateUtil.format(new Date(y, m, d));
        const cell = document.createElement("div");
        cell.className = "day-cell";
        if (dateStr === today) cell.classList.add('today');
        
        cell.innerHTML = `<div class="day-number">${d}</div>`;

        const dayEvents = events.filter(e => e.date === dateStr);
        if (dayEvents.length > 0) {
          const container = document.createElement("div");
          container.className = "event-badges";
          dayEvents.forEach(e => {
            const span = document.createElement("span");
            span.className = `badge ${e.kind}`;
            span.textContent = e.kind === 'preg-check' ? 'é‘‘å®š' : 'åˆ†å¨©';
            container.appendChild(span);
          });
          cell.appendChild(container);
        }

        cell.onclick = () => openModal(dateStr, dayEvents);
        grid.appendChild(cell);
      }
    }

    // ç‰›ãƒªã‚¹ãƒˆè¡¨ç¤º
    let currentFilter = 'all';
    let currentSort = 'date';
    let currentSearch = '';

    function renderCowList() {
      const listDiv = document.getElementById("cowList");
      listDiv.innerHTML = "";
      let cows = getCows();

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      if (currentFilter !== 'all') {
        cows = cows.filter(c => c.status === currentFilter);
      }

      // æ¤œç´¢
      if (currentSearch) {
        cows = cows.filter(c => c.name.includes(currentSearch));
      }

      // ã‚½ãƒ¼ãƒˆ
      if (currentSort === 'name') {
        cows.sort((a, b) => a.name.localeCompare(b.name, 'ja'));
      } else {
        cows.sort((a, b) => new Date(b.inseminationDate) - new Date(a.inseminationDate));
      }

      if (cows.length === 0) {
        listDiv.innerHTML = '<div style="text-align:center; padding:40px; color:#a0aec0">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      cows.forEach((cow, displayIdx) => {
        const actualIdx = getCows().findIndex(c => 
          c.name === cow.name && c.inseminationDate === cow.inseminationDate
        );
        
        const card = document.createElement("div");
        card.className = `cow-card status-${cow.status}`;
        card.style.animationDelay = `${displayIdx * 0.05}s`;

        const is_open = cow.status === 'open';
        const pregDate = dateUtil.addDays(cow.inseminationDate, 60);
        const dueDate = dateUtil.addDays(cow.inseminationDate, 285);

        let statusLabels = "";
        if (!is_open) {
          // â† ã“ã“ã‚’ä¿®æ­£ï¼šæˆç²¾æ¸ˆã¿ã®å ´åˆã¯é‘‘å®šäºˆå®šã®ã¿è¡¨ç¤º
          if (cow.status === 'inseminated') {
            statusLabels = `<div class="date-highlight">ğŸ“‹ é‘‘å®šäºˆå®š: ${pregDate}</div>`;
          } else if (cow.status === 'pregnant') {
            statusLabels = `<div class="date-highlight-green">ğŸ® åˆ†å¨©äºˆå®š: ${dueDate}</div>`;
          }
        } else {
          statusLabels = `<div class="small" style="color:#e53e3e; font-weight:600">âš ï¸ ç©ºèƒã®ãŸã‚äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
        }

        const statusText = {
          'inseminated': 'æˆç²¾æ¸ˆã¿',
          'pregnant': 'å¦Šå¨ ä¸­',
          'open': 'ç©ºèƒ'
        }[cow.status];

        card.innerHTML = `
          <div class="cow-header">
            <div>
              <span class="cow-name">${cow.name}</span>
              <span class="bull-name">${cow.bull || 'æœªè¨­å®š'}</span>
            </div>
            <select style="width:120px; font-size:0.85rem; padding:8px" onchange="updateStatus(${actualIdx}, this.value)">
              <option value="inseminated" ${cow.status==='inseminated'?'selected':''}>æˆç²¾æ¸ˆã¿</option>
              <option value="pregnant" ${cow.status==='pregnant'?'selected':''}>å¦Šå¨ ä¸­</option>
              <option value="open" ${cow.status==='open'?'selected':''}>ç©ºèƒ</option>
            </select>
          </div>
          <div class="small mb-2">ğŸ“… äººå·¥æˆç²¾æ—¥: ${cow.inseminationDate}</div>
          <div style="margin-top:12px">${statusLabels}</div>
          <button onclick="deleteCow(${actualIdx})" style="background:#fc8181; color:white; font-size:0.85rem; width:auto; padding:8px 16px; margin-top:12px">ğŸ—‘ï¸ å‰Šé™¤</button>
        `;
        listDiv.appendChild(card);
      });
    }

    // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document.getElementById('searchInput').addEventListener('input', (e) => {
      currentSearch = e.target.value;
      renderCowList();
    });

    function filterCows() {
      currentFilter = document.getElementById('filterStatus').value;
      renderCowList();
    }

    function sortCows() {
      currentSort = document.getElementById('sortBy').value;
      renderCowList();
    }

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    async function updateStatus(idx, newStatus) {
      const cows = getCows();
      const oldStatus = cows[idx].status;
      cows[idx].status = newStatus;
      saveCows(cows);
      refreshUI();
      
      const statusText = {
        'inseminated': 'æˆç²¾æ¸ˆã¿',
        'pregnant': 'å¦Šå¨ ä¸­',
        'open': 'ç©ºèƒ'
      }[newStatus];
      showToast(`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${statusText}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
    }

    async function deleteCow(idx) {
      const cows = getCows();
      const confirmed = await showConfirm(`ã€Œ${cows[idx].name}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!confirmed) return;
      
      cows.splice(idx, 1);
      saveCows(cows);
      refreshUI();
      showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'error');
    }

    function refreshUI() {
      updateStats();
      renderCowList();
      renderCalendar();
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    function exportData() {
      const cows = getCows();
      const dataStr = JSON.stringify(cows, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cow_data_${dateUtil.format(new Date())}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data)) {
            saveCows(data);
            refreshUI();
            showToast('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
          } else {
            showToast('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™', 'error');
          }
        } catch (err) {
          showToast('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById("cowForm").onsubmit = (e) => {
      e.preventDefault();
      const name = document.getElementById("cowName").value.trim();
      const date = document.getElementById("inseminationDate").value;
      const bull = document.getElementById("bullName").value.trim();
      
      if (!name || !date) {
        showToast('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      const cows = getCows();
      cows.push({ name, inseminationDate: date, bull, status: 'inseminated' });
      saveCows(cows);
      
      e.target.reset();
      refreshUI();
      showToast(`ã€Œ${name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success');
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    function openModal(dateStr, dayEvents) {
      const overlay = document.getElementById("modalOverlay");
      const title = document.getElementById("modalDateTitle");
      const eventsDiv = document.getElementById("modalEvents");

      title.textContent = `ğŸ“… ${dateStr}`;
      eventsDiv.innerHTML = "";

      if (dayEvents.length === 0) {
        eventsDiv.innerHTML = "<p class='small text-center' style='padding:20px'>ã“ã®æ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>";
      } else {
        dayEvents.forEach(ev => {
          const div = document.createElement("div");
          div.className = "event-item";
          div.innerHTML = `
            <strong style="font-size:1.1rem">${ev.title}</strong><br>
            <span class="small">ğŸ„ å¯¾è±¡ç‰›: <strong>${ev.cowName}</strong></span>
            <div style="margin-top:12px">
              <label class="small" style="margin-bottom:6px">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:</label>
              <select style="width:100%" onchange="updateStatus(${ev.cowIndex}, this.value); closeModal();">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="pregnant">âœ“ å¦Šå¨ ç¢ºèª</option>
                <option value="open">âœ• ç©ºèƒã«å¤‰æ›´</option>
              </select>
            </div>
          `;
          eventsDiv.appendChild(div);
        });
      }
      overlay.style.display = "flex";
    }

    function closeModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }
    document.getElementById("closeModal").onclick = closeModal;

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.getElementById("prevMonth").onclick = () => {
      currentViewDate.setMonth(currentViewDate.getMonth()-1);
      renderCalendar();
    };
    
    document.getElementById("nextMonth").onclick = () => {
      currentViewDate.setMonth(currentViewDate.getMonth()+1);
      renderCalendar();
    };
    
    document.getElementById("todayBtn").onclick = () => {
      currentViewDate = new Date();
      renderCalendar();
      showToast('ä»Šæœˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ', 'success');
    };

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
        closeConfirm(false);
      }
    });

    // åˆæœŸèµ·å‹•æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    window.addEventListener('load', () => {
      refreshUI();
      // ä»Šæ—¥ã®æˆç²¾æ—¥ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
      document.getElementById('inseminationDate').valueAsDate = new Date();
    });

    // åˆæœŸè¡¨ç¤º
    refreshUI();
  </script>

</body>
</html>
